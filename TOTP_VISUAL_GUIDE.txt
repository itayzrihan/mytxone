```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ğŸ” TOTP 2FA IMPLEMENTATION - COMPLETE GUIDE ğŸ”                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STATUS: 80% COMPLETE âœ…                                                      â”‚
â”‚                                                                              â”‚
â”‚ All backend infrastructure is ready and tested.                             â”‚
â”‚ Just wire it into your login/register flow!                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ ğŸ“‹ WHAT'S ALREADY DONE (No Work Needed)                                     â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

  âœ… Database Schema Updated
     â””â”€ totp_secret (encrypted)
     â””â”€ totp_enabled (boolean)
     â””â”€ totp_seed_id (reference)
     â””â”€ totp_setup_completed (timestamp)

  âœ… Core Library (lib/totp.ts - 268 lines)
     â””â”€ AES-256-GCM Encryption
     â””â”€ TOTP Generation (8 digits)
     â””â”€ Code Verification
     â””â”€ Rate Limiting Support
     â””â”€ Recovery Codes

  âœ… API Endpoints (3 routes)
     â””â”€ POST /api/auth/setup-2fa       â†’ Initiate 2FA setup
     â””â”€ GET /api/auth/totp-callback    â†’ Receive & store secret
     â””â”€ POST /api/auth/verify-2fa      â†’ Verify 8-digit code

  âœ… React Components (2 components)
     â””â”€ TwoFASetupModal                â†’ Beautiful setup UI
     â””â”€ TwoFAVerificationForm          â†’ Code input form

  âœ… Rate Limiting
     â””â”€ Redis-based (Upstash)
     â””â”€ 5 attempts per 15 minutes
     â””â”€ Prevents brute force

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ ğŸ”§ WHAT YOU NEED TO DO (Simple Steps!)                                      â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

  STEP 1: Generate Encryption Key (2 minutes)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    PowerShell (Windows):
    $ $key = [System.Security.Cryptography.RandomNumberGenerator]::Create().GetBytes(32)
    $ [BitConverter]::ToString($key) -replace '-'
    
    Result: a1b2c3d4e5f6g7h8... (64 hex characters)

    OR Node.js (All platforms):
    $ node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"


  STEP 2: Configure Environment (2 minutes)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    Add to .env.local:
    
    TOTP_ENCRYPTION_KEY=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6...
    
    (Keep existing vars: UPSTASH_REDIS_REST_URL, NEXTAUTH_URL, etc)


  STEP 3: Run Migration (5 minutes)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    $ npm run build
    
    Output: âœ… Migration completed successfully


  STEP 4: Wire Login Flow (15 minutes)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    File: app/(auth)/actions.ts
    
    Add after password validation:
    
    const [user] = await getUser(validatedData.email);
    if (user && user.totpEnabled) {
      return { 
        status: "2fa_required",
        userEmail: validatedData.email
      };
    }


  STEP 5: Update Login UI (10 minutes)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    File: app/(auth)/login/page.tsx
    
    Import: TwoFAVerificationForm
    
    In render:
    
    {show2FA ? (
      <TwoFAVerificationForm userEmail={userEmail} />
    ) : (
      <AuthForm /> {/* existing form */}
    )}


  STEP 6: Add Setup to Registration (10 minutes)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    File: app/(auth)/register/page.tsx
    
    Import: TwoFASetupModal
    
    Show modal after successful registration (optional)


  STEP 7: Test Complete Flow (15 minutes)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    1. npm run dev
    2. Register new account â†’ Enable 2FA
    3. Scan QR with authenticator app
    4. Log out â†’ Log back in
    5. Enter password â†’ See 2FA form
    6. Enter 8-digit code â†’ Login successful âœ…

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ ğŸŒŠ DATA FLOW DIAGRAM                                                         â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

  REGISTRATION FLOW:
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    User Registers
         â†“
    Password Valid
         â†“
    [Optional] Show 2FA Setup
         â†“
    User Clicks "Enable 2FA"
         â†“
    GET /api/auth/setup-2fa
         â†“
    Returns Legitate Link
         â†“
    User Scans QR Code
         â†“
    Legitate Generates Secret
         â†“
    GET /api/auth/totp-callback
         â†“
    Secret Encrypted & Stored
         â†“
    âœ… 2FA Enabled!


  LOGIN FLOW (With 2FA Enabled):
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    User Enters Email + Password
             â†“
    Credentials Valid?
      â”œâ”€ NO â†’ Show Error
      â”‚
      â””â”€ YES â†’ 2FA Enabled?
          â”œâ”€ NO â†’ Log In Directly
          â”‚
          â””â”€ YES â†’ Show "Enter Code" Form
               â†“
          User Enters 8-Digit Code
               â†“
          POST /api/auth/verify-2fa
               â†“
          Decrypt Stored Secret
               â†“
          Generate Expected Code
               â†“
          Code Matches?
              â”œâ”€ NO â†’ Wrong Attempts++
              â”‚       â””â”€ 5+ Attempts? â†’ Block 15 Min
              â”‚       â””â”€ Show Error, Try Again
              â”‚
              â””â”€ YES â†’ âœ… Log In!

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ ğŸ“‚ FILES TO EDIT                                                             â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

  MUST EDIT:
  â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â”œâ”€ app/(auth)/actions.ts           â†’ Add 2FA check
  â”œâ”€ app/(auth)/login/page.tsx       â†’ Show 2FA form
  â””â”€ .env.local                       â†’ Add encryption key

  OPTIONAL:
  â”€â”€â”€â”€â”€â”€â”€â”€
  â””â”€ app/(auth)/register/page.tsx    â†’ Show setup modal (nice to have)

  INFRASTRUCTURE (Already Done):
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â”œâ”€ lib/totp.ts                          âœ… Complete
  â”œâ”€ app/api/auth/setup-2fa/route.ts      âœ… Complete
  â”œâ”€ app/api/auth/totp-callback/route.ts  âœ… Complete
  â”œâ”€ app/api/auth/verify-2fa/route.ts     âœ… Complete
  â”œâ”€ components/custom/two-fa-setup-modal.tsx      âœ… Complete
  â”œâ”€ components/custom/two-fa-verification-form.tsx âœ… Complete
  â””â”€ db/schema.ts                         âœ… Complete

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ â±ï¸  TIME ESTIMATES                                                            â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

  Step 1 (Generate Key)      â†’   2 minutes  âš¡
  Step 2 (Env Config)        â†’   2 minutes  âš¡
  Step 3 (Migration)         â†’   5 minutes  âš¡
  Step 4 (Wire Login)        â†’  15 minutes  ğŸ”§
  Step 5 (Login UI)          â†’  10 minutes  ğŸ”§
  Step 6 (Registration)      â†’  10 minutes  ğŸ”§
  Step 7 (Testing)           â†’  15 minutes  âœ…
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  TOTAL                      â†’  ~60 minutes ğŸ¯

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ ğŸ”‘ KEY FEATURES                                                              â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

  ğŸ” Security
     â”œâ”€ AES-256-GCM Encryption (Military Grade)
     â”œâ”€ Rate Limiting (5 attempts / 15 min)
     â”œâ”€ Replay Attack Prevention
     â””â”€ Secure Key Storage

  ğŸ“± Compatible With
     â”œâ”€ Google Authenticator
     â”œâ”€ Microsoft Authenticator
     â”œâ”€ Authy
     â”œâ”€ Any RFC 6238 App
     â””â”€ Most authenticators!

  ğŸ”¢ TOTP Code Format
     â”œâ”€ 8 Digits (not 6)
     â”œâ”€ 30-Second Expiry
     â”œâ”€ Â±30 Second Window
     â””â”€ Industry Standard (RFC 6238)

  ğŸ’¾ Storage
     â”œâ”€ Encrypted in DB
     â”œâ”€ Per-User Control
     â”œâ”€ Enable/Disable Anytime
     â””â”€ Setup Completion Tracked

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ ğŸ“š DOCUMENTATION                                                             â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

  START HERE:
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ğŸ“– TOTP_IMPLEMENTATION_COMPLETE.md
     â””â”€ Step-by-step guide with code examples

  QUICK REFERENCE:
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  âœ… TOTP_QUICK_CHECKLIST.md
     â””â”€ Checklist format for easy tracking

  SUMMARY:
  â”€â”€â”€â”€â”€â”€â”€â”€
  ğŸ“‹ TOTP_IMPLEMENTATION_SUMMARY.md
     â””â”€ High-level overview

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ âœ¨ YOU'RE READY TO GO! ğŸš€                                                    â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

  1. Read: TOTP_IMPLEMENTATION_COMPLETE.md (10 min)
  2. Execute: Steps 1-3 (9 min)
  3. Implement: Steps 4-6 (35 min)
  4. Test: Step 7 (15 min)
  5. Deploy: With proper env vars âœ…

  Total: ~1 hour to production-ready 2FA! ğŸ’ª

```
